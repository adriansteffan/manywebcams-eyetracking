<!DOCTYPE html>
<html>
    <head>
        <title>MB2 Eye Tracking</title>

        <!-- Import JSZIP for downloading of trial data in development/testing setup -->
        <script 
            src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js" 
            integrity="sha512-uVSVjE7zYsGz4ag0HEzfugJ78oHCI1KhdkivjQro8ABL/PRiEO4ROwvrolYAcZnky0Fl/baWKYilQfWvESliRA==" 
            crossorigin="anonymous">
        </script>

        <script src="jspsych-6.3.1/jspsych.js"></script>
        <script src="jspsych-6.3.1/examples/js/webgazer/webgazer.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-preload.js"></script>

        <script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-video-keyboard-response.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-webgazer-calibrate.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-webgazer-init-camera.js"></script>
        <script src="jspsych-6.3.1/plugins/jspsych-webgazer-validate.js"></script>

        <script src="jspsych-6.3.1/extensions/jspsych-ext-webgazer.js"></script>
        <script src="jspsych-6.3.1/extensions/jspsych-ext-webcam-recorder.js"></script>
        <script src="jspsych-6.3.1/extensions/jspsych-ext-background-audio.js"></script>

        <link href="jspsych-6.3.1/css/jspsych.css" rel="stylesheet" type="text/css">
        <link href="patch.css" rel="stylesheet" type="text/css">
    </head>
    <body></body>
    <script>        

        // save data locally on the server
        function saveData(filetype, name, data){
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'write_data.php');
            xhr.setRequestHeader('Content-Type', 'application/json'); 
            if(filetype==="webm"){
                var reader = new FileReader();
                reader.readAsDataURL(data);  
                reader.onloadend = () => {  
                    xhr.send(JSON.stringify({filename: name, filedata: reader.result, filetype: filetype}));                
                }
            } else{
                xhr.send(JSON.stringify({filename: name, filedata: data, filetype: filetype}));
            }
        }

        function createUUID(){
            /*We need a way to identify subjects that did not specify an id in the url
            a less messy aproach would be to generate these with a sophisticated backend server*/

            let dt = new Date().getTime()
            
            const uuid = 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (dt + Math.random()*16)%16 | 0
                dt = Math.floor(dt/16)
                return (c=='x' ? r :(r&0x3|0x8)).toString(16)
            })
            return uuid
        }


        var videos = {  
            FAM_LL: 'media/video/FAM_LL.mp4',
            FAM_LR: 'media/video/FAM_LR.mp4',
            FAM_RL: 'media/video/FAM_RL.mp4',
            FAM_RR: 'media/video/FAM_RR.mp4',
            IG_LL: 'media/video/IG_LL.mp4',
            IG_LR: 'media/video/IG_LR.mp4',
            IG_RL: 'media/video/IG_RL.mp4',
            IG_RR: 'media/video/IG_RR.mp4',
            KNOW_LL: 'media/video/KNOW_LL.mp4',
            KNOW_LR: 'media/video/KNOW_LR.mp4',
            KNOW_RL: 'media/video/KNOW_RL.mp4',
            KNOW_RR: 'media/video/KNOW_RR.mp4',
        }

        var familiarizationOrders = {
            A: [videos.FAM_LR, videos.FAM_RR, videos.FAM_LL, videos.FAM_RL],
            B: [videos.FAM_RL, videos.FAM_LL, videos.FAM_LR, videos.FAM_RR]
        }

        var trialOrders = {
            1: ["A", videos.KNOW_RR, videos.IG_RR],
            2: ["B", videos.KNOW_RL, videos.IG_RR],
            3: ["A", videos.KNOW_LR, videos.IG_RR],
            4: ["B", videos.KNOW_LL, videos.IG_RR],
            5: ["A", videos.KNOW_RR, videos.IG_RL],
            6: ["B", videos.KNOW_RL, videos.IG_RL],
            7: ["A", videos.KNOW_LR, videos.IG_RL],
            8: ["B", videos.KNOW_LL, videos.IG_RL],
            9: ["A", videos.IG_RR, videos.KNOW_LR],
            10: ["B", videos.IG_RL, videos.KNOW_LR],
            11: ["A", videos.IG_LR, videos.KNOW_LR],
            12: ["B", videos.IG_LL, videos.KNOW_LR],
            13: ["A", videos.IG_RR, videos.KNOW_LL],
            14: ["B", videos.IG_RL, videos.KNOW_LL],
            15: ["A", videos.IG_LR, videos.KNOW_LL],
            16: ["B", videos.IG_LL, videos.KNOW_LL],
            17: ["A", videos.IG_RR, videos.KNOW_RR],
            18: ["B", videos.IG_RL, videos.KNOW_RR],
            19: ["A", videos.IG_LR, videos.KNOW_RR],
            20: ["B", videos.IG_LL, videos.KNOW_RR],
            21: ["A", videos.IG_RR, videos.KNOW_RL],
            22: ["B", videos.IG_RL, videos.KNOW_RL],
            23: ["A", videos.IG_LR, videos.KNOW_RL],
            24: ["B", videos.IG_LL, videos.KNOW_RL],
            25: ["A", videos.KNOW_RR, videos.IG_LR],
            26: ["B", videos.KNOW_RL, videos.IG_LR],
            27: ["A", videos.KNOW_LR, videos.IG_LR],
            28: ["B", videos.KNOW_LL, videos.IG_LR],
            29: ["A", videos.KNOW_RR, videos.IG_LL],
            30: ["B", videos.KNOW_RL, videos.IG_LL],
            31: ["A", videos.KNOW_LR, videos.IG_LL],
            32: ["B", videos.KNOW_LL, videos.IG_LL],    
        }

        var trialOrder = parseInt(jsPsych.data.urlVariables().trial_order);
        
        if(isNaN(trialOrder) || trialOrder <= 0 || trialOrder > Object.keys(trialOrders).length){
            const random = (min, max) => Math.floor(Math.random() * (max - min)) + min;
            trialOrder = random(1, Object.keys(trialOrders).length);
        }
        
        var stimuliUsed = trialOrders[trialOrder];
        var famUsed = familiarizationOrders[stimuliUsed[0]];

        var subjectId = jsPsych.data.urlVariables().id;
        var subjectString = (subjectId ? (subjectId) : createUUID())+"_";

        var downloadTrialData = false || !!(jsPsych.data.urlVariables().download_data);
        var aoiDebug = false || !!(jsPsych.data.urlVariables().show_aoi);
        var printDataDebug = false || !!(jsPsych.data.urlVariables().print_data);
        var preventDataUpload = false || !!(jsPsych.data.urlVariables().prevent_upload);
        


        var preload = {
            type: 'preload',
            images: [],
            audio: [],
            // stimuliUsed[0] is the identifier for the familiarization trial order used
            videos: [stimuliUsed[1], stimuliUsed[2]].concat(famUsed) 
        }

        var welcome = {
            type: "html-keyboard-response",
            stimulus: "TODO: Informed Consent, Instructions. Press any key to continue",
        };

        var end = {
            type: "html-keyboard-response",
            stimulus: "Thanks for participating! Press any key to submit your data",
        };

        var permission = {
            type: "html-keyboard-response",
            stimulus: "Your browser will ask you for permission to use the microphone and webcam. Please accept and press any key to continue afterwards.",
            extensions: [
                    {
                        type: 'webcam-recorder', 
                        params: {
                            videoName: "permission"
                        }
                    }
            ],
        };

        var init_camera_trial = {
            type: 'webgazer-init-camera',
            instructions: `<p>(All these instructional texts needs to change) Position your head so that the webcam has a good view of your eyes.</p>
            <p>Center your face in the box and look directly towards the camera.</p>
            <p>It is important that you try and keep your head reasonably still throughout the experiment, so please take a moment to adjust your setup to be comfortable.</p>
            <p>When your face is centered in the box and the box is green, you can click to continue.</p>`,
            button_text:"Start",
            extensions: [
                    {
                        type: 'webcam-recorder', 
                        params: {
                            videoName: "webcam-init"
                        }
                    }
            ],
        }

        var calibration1_trial = {
            type: 'webgazer-calibrate',
            calibration_points: [[12,50], [50,50], [88,50], [50,12], [50,88], ],//[25,50], [50,75], [75,50], [50,25]],
            calibration_mode: 'view',
            time_per_point: 1600,
            extensions: [
                    {
                        type: 'webcam-recorder', 
                        params: {
                            videoName: "calibration"
                        }
                    },
                    {
                        type: 'background-audio', 
                        params: {}
                    }
            ],
            data: {
                task: 'webgazer-calibrate',
            }
        }

        var validation_trial = { 
            type: 'webgazer-validate',
            validation_points: [[-200,200], [200,200],[-200,-200],[200,-200]],
            validation_point_coordinates: 'center-offset-pixels',
            roi_radius: 130,
            extensions: [
                    {
                        type: 'webcam-recorder', 
                        params: {
                            videoName: "validation"
                        }
                    },
                    {
                        type: 'background-audio', 
                        params: {}
                    }
            ],
        }

        var instructions = {
            type: "html-keyboard-response",
            stimulus: `
                <p>Press any key to begin.</p>
            `,
            post_trial_gap: 1000
        };
            
        

        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: jsPsych.NO_KEYS,
            trial_duration: 2000,
            data: {
                task: 'fixation',
                windowHeight: () => window.innerHeight,
                windowWidth: () => window.innerWidth,
            },
            extensions: [
                {
                    type: 'webgazer', 
                    params: { 
                        targets: ['#scene']
                    }
                }
            ],
        }

        var video = {
            type: "video-keyboard-response",
            stimulus: jsPsych.timelineVariable('stimulus'),
            autoplay: true,
            controls: false,
            height: () => window.innerHeight,
            trial_ends_after_video: true,
            choices: jsPsych.NO_KEYS,
            data: {
                task: 'video',
                windowHeight: () => window.innerHeight,
                windowWidth: () => window.innerWidth,
            },
            extensions: [
                {
                    type: 'webgazer', 
                    params: { 
                        targets: ['#scene'],
                        aoiData: {
                            debug: aoiDebug,
                            aois: [
                                {
                                    name: "blue_rectangle_bottom_left",
                                    type: "rect",
                                    stimulusAspectRatio: 4/3,
                                    rposx: 0,
                                    rposy: 0.55,
                                    rwidth: 0.43,
                                    rheight: 0.45,
                                    startat: null,
                                    stopat: null,
                                    debugColor: "blue",
                                },
                                {
                                    name: "blue_rectangle_bottom_right",
                                    type: "rect",
                                    stimulusAspectRatio: 4/3,
                                    rposx: 0.57,
                                    rposy: 0.55,
                                    rwidth: 0.43,
                                    rheight: 0.45,
                                    startat: null,
                                    stopat: null,
                                    debugColor: "blue",
                                },
                                {
                                    name: "red_rectangle_pipe_left",
                                    type: "rect",
                                    stimulusAspectRatio: 4/3,
                                    rposx: 0.20,
                                    rposy: 0.60,
                                    rwidth: 0.17,
                                    rheight: 0.20,
                                    startat: null,
                                    stopat: null,
                                    debugColor: "red",
                                },
                                {
                                    name: "red_rectangle_pipe_right",
                                    type: "rect",
                                    stimulusAspectRatio: 4/3,
                                    rposx: 0.63,
                                    rposy: 0.60,
                                    rwidth: 0.17,
                                    rheight: 0.20,
                                    startat: null,
                                    stopat: null,
                                    debugColor: "red",
                                },
                            ],
                            
                        }
                    }
                },
                {
                    type: 'webcam-recorder', 
                    params: {
                        videoName: jsPsych.timelineVariable('stimulus'),
                    }
                }
            ],
        }


        var fam_stimuli = [
            { stimulus : [famUsed[0]] },
            { stimulus : [famUsed[1]] },
            { stimulus : [famUsed[2]] },
            { stimulus : [famUsed[3]] },
        ];

        var test_stimuli = [
            { stimulus : [ stimuliUsed[1] ] },
            { stimulus : [ stimuliUsed[2] ] },
        ];

        var fam_videos = {
            timeline: [video],
            timeline_variables: fam_stimuli,
            repetitions: 1
        }
            
        var test_videos = {
            timeline: [video],
            timeline_variables: test_stimuli,
            repetitions: 1
        }

        var startFullscreen = {
            type: 'fullscreen',
            fullscreen_mode: true
        }

        var stopFullscreen = {
            type: 'fullscreen',
            fullscreen_mode: false
        }

        var timeline = [
            preload,
            welcome,
            permission,
            startFullscreen, 
            init_camera_trial, 
            calibration1_trial, 
            //validation_trial,
            fam_videos,
            //calibration2_trial, 
            test_videos, 
            stopFullscreen, 
            end
        ];


        jsPsych.init({
            timeline: timeline,
            use_webaudio: false,
            on_finish: function() {

                if(printDataDebug){
                    var jspsychelemnt = document.querySelector(".jspsych-display-element");
                    jspsychelemnt.style.overflowY = "auto";
                    jsPsych.data.displayData();
                }

                // video name is the stimulus filepath, cleaning that up
                var nameFromMediaPath = function(path){
                    return path.toString().split("/").pop().split(".")[0];
                }

                
                if(downloadTrialData){
                    var zip = new JSZip();
                    zip.file(subjectString+trialOrder+"_data.json", jsPsych.data.get().json());
                    window.webcamVideoBlobs.forEach(({blob, name}, i) => {
                        zip.file(subjectString+trialOrder+"_"+nameFromMediaPath(name)+".webm", blob);
                    }); 

                    zip.generateAsync({type:"blob"})
                    .then(function(content) {
                        var a = document.createElement('a');
                        a.style.display = 'none';
                        document.body.append(a);
                        var url = URL.createObjectURL(content);
                        a.href = url;
                        a.download = "experiment.zip";
                        a.click();
                        URL.revokeObjectURL(url);
                        a.remove();
                    });
                }

                if(!preventDataUpload){
                    saveData("json", subjectString+trialOrder+"_data", jsPsych.data.get().json());
                    window.webcamVideoBlobs.forEach(({blob, name}, i) => {
                        saveData("webm", subjectString+trialOrder+"_"+nameFromMediaPath(name), blob);
                    }); 
                }
            },
            extensions: [
                {type: 'webgazer'}
            ]
        });
    
    </script>
</html>

<!-- Something to think about: make choosing images/gifs for the fixation points optional-->
<!-- Something to think about: improve the audio extension-->